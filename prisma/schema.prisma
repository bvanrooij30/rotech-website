// Prisma Schema for Ro-Tech Development Customer Portal
// Database: PostgreSQL (Supabase) for production, SQLite for local dev

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String    // Hashed with bcrypt
  name          String
  phone         String?
  
  // Company info (optional for freelancers)
  companyName   String?
  kvkNumber     String?
  vatNumber     String?
  
  // Address
  street        String?
  houseNumber   String?
  postalCode    String?
  city          String?
  country       String    @default("Nederland")
  
  // Status
  emailVerified DateTime?
  isActive      Boolean   @default(true)
  role          String    @default("customer") // customer, admin, super_admin
  
  // Admin permissions (JSON array of permission strings)
  permissions   String?   // ["users.read", "users.write", "subscriptions.manage", etc.]
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  // Relations
  subscriptions Subscription[]
  products      Product[]
  supportTickets SupportTicket[]
  invoices      Invoice[]
  sessions      Session[]
  automationSubscriptions AutomationSubscription[]
  
  @@index([email])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now())
  
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// SUBSCRIPTIONS (Maintenance Packages)
// ============================================

model Subscription {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Subscription details
  planType        String   // basis, business, premium
  planName        String   // Display name
  monthlyPrice    Float    // Price per month
  
  // Stripe integration
  stripeSubscriptionId String? @unique
  stripeCustomerId     String?
  stripePriceId        String?
  
  // Status
  status          String   @default("active") // active, paused, cancelled, past_due
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean @default(false)
  
  // Features included
  hoursIncluded   Float    @default(0)  // Monthly hours included
  hoursUsed       Float    @default(0)  // Hours used this period
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  cancelledAt     DateTime?
  
  // Relations
  product         Product? @relation(fields: [productId], references: [id])
  productId       String?
  usageLogs       UsageLog[]
  
  @@index([userId])
  @@index([status])
}

model UsageLog {
  id             String   @id @default(cuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  description    String
  hours          Float
  date           DateTime @default(now())
  category       String   // update, bugfix, feature, support
  
  createdAt      DateTime @default(now())
  
  @@index([subscriptionId])
}

// ============================================
// PRODUCTS (Websites, Apps, etc.)
// ============================================

model Product {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Product info
  name            String   // "Bedrijfswebsite", "Webshop", etc.
  type            String   // website, webshop, webapp, api
  description     String?
  
  // Technical details
  domain          String?  // e.g., "klant.nl"
  hostingProvider String?
  techStack       String?  // JSON string of technologies
  
  // Status
  status          String   @default("active") // development, active, maintenance, archived
  launchDate      DateTime?
  
  // Project reference
  originalQuoteId String?  // Reference to original quote
  projectValue    Float?   // Original project value
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  subscriptions   Subscription[]
  supportTickets  SupportTicket[]
  statusUpdates   StatusUpdate[]
  
  @@index([userId])
  @@index([status])
}

model StatusUpdate {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  title     String
  message   String
  type      String   // info, update, maintenance, issue, resolved
  isPublic  Boolean  @default(true)
  
  createdAt DateTime @default(now())
  createdBy String   // admin user id or "system"
  
  @@index([productId])
}

// ============================================
// SUPPORT TICKETS
// ============================================

model SupportTicket {
  id            String   @id @default(cuid())
  ticketNumber  String   @unique // RT-2024-001 format
  
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  productId     String?
  product       Product? @relation(fields: [productId], references: [id])
  
  // Ticket details
  subject       String
  description   String
  category      String   // general, technical, billing, feature-request
  priority      String   @default("medium") // low, medium, high, urgent
  
  // Status
  status        String   @default("open") // open, in_progress, waiting_customer, resolved, closed
  
  // Admin portal sync
  adminPortalId String?  // ID in Ro-Tech Admin Portal
  syncedAt      DateTime?
  
  // Resolution
  resolution    String?
  resolvedAt    DateTime?
  resolvedBy    String?
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  messages      TicketMessage[]
  
  @@index([userId])
  @@index([status])
  @@index([ticketNumber])
}

model TicketMessage {
  id           String   @id @default(cuid())
  ticketId     String
  ticket       SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  senderType   String   // customer, support, ai, system
  senderName   String
  senderId     String?  // User id if customer
  
  message      String
  
  // Attachments (URLs to stored files)
  attachments  String?  // JSON array of URLs
  
  // Read status
  isRead       Boolean  @default(false)
  readAt       DateTime?
  
  createdAt    DateTime @default(now())
  
  @@index([ticketId])
}

// ============================================
// INVOICES
// ============================================

model Invoice {
  id              String   @id @default(cuid())
  invoiceNumber   String   @unique // RT-INV-2024-001
  
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Stripe reference
  stripeInvoiceId String?  @unique
  
  // Invoice details
  amount          Float    // Total amount in EUR
  tax             Float    // VAT amount
  status          String   // draft, open, paid, void, uncollectible
  
  description     String?
  dueDate         DateTime?
  paidAt          DateTime?
  
  // PDF
  pdfUrl          String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
}

// ============================================
// ADMIN AUDIT LOG
// ============================================

model AdminAuditLog {
  id          String   @id @default(cuid())
  adminId     String   // The admin who performed the action
  adminEmail  String
  
  // Action details
  action      String   // user.create, subscription.update, etc.
  targetType  String   // user, subscription, product, ticket, invoice
  targetId    String?  // ID of the affected record
  
  // Before/After snapshots (JSON)
  before      String?  // JSON snapshot before change
  after       String?  // JSON snapshot after change
  
  // Metadata
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())
  
  @@index([adminId])
  @@index([action])
  @@index([targetType])
  @@index([createdAt])
}

// ============================================
// SYSTEM SETTINGS
// ============================================

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   // JSON value
  category  String   // general, email, payments, seo, security
  
  updatedAt DateTime @updatedAt
  updatedBy String?  // Admin ID who last updated
}

// ============================================
// AI AGENTS SYSTEM
// ============================================

// Agent activity and status logging
model AgentLog {
  id        String   @id @default(cuid())
  agentId   String   // master-agent, intake-agent, etc.
  agentType String   // system, service
  level     String   // debug, info, warn, error, critical
  message   String
  data      String?  // JSON additional data
  projectId String?
  
  createdAt DateTime @default(now())
  
  @@index([agentId])
  @@index([level])
  @@index([createdAt])
}

// AI-generated leads
model AILead {
  id          String   @id @default(cuid())
  
  // Contact info
  companyName String
  contactName String
  email       String
  phone       String?
  website     String?
  
  // Lead details
  source      String   // linkedin, google, website, referral
  interest    String
  message     String?
  budget      String?
  timeline    String?
  
  // AI scoring
  score       Int      @default(50)
  recommendation String @default("warm") // hot, warm, cold, disqualified
  reasoning   String?
  
  // Recommended package
  suggestedPackage String?
  estimatedValue   Float?
  
  // Status tracking
  status      String   @default("new") // new, contacted, qualified, proposal, won, lost
  assignedTo  String?  // agent ID handling this lead
  
  // Notes (JSON array)
  notes       String?
  
  // Follow-up
  nextFollowUp DateTime?
  lastContact  DateTime?
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  activities  LeadActivity[]
  
  @@index([status])
  @@index([score])
  @@index([source])
  @@index([createdAt])
}

model LeadActivity {
  id       String   @id @default(cuid())
  leadId   String
  lead     AILead   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  type     String   // email_sent, call_made, meeting_scheduled, proposal_sent, etc.
  title    String
  details  String?
  agentId  String   // Which AI agent performed this
  
  createdAt DateTime @default(now())
  
  @@index([leadId])
  @@index([agentId])
}

// Marketing campaigns managed by Marketing Agent
model AICampaign {
  id          String   @id @default(cuid())
  
  name        String
  type        String   // email, social, content, seo, ppc
  status      String   @default("draft") // draft, active, paused, completed
  
  // Target
  targetAudience String?
  targetSegment  String?
  targetSize     Int?
  
  // Budget
  budgetAllocated Float @default(0)
  budgetSpent     Float @default(0)
  
  // Metrics
  impressions     Int   @default(0)
  clicks          Int   @default(0)
  conversions     Int   @default(0)
  leads           Int   @default(0)
  revenue         Float @default(0)
  
  // Schedule
  startDate   DateTime?
  endDate     DateTime?
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Content (JSON array)
  content     String?
  
  @@index([status])
  @@index([type])
}

// Scheduled tasks for agents
model AIScheduledTask {
  id          String   @id @default(cuid())
  
  type        String   // project, maintenance, marketing, optimization, report
  agentId     String   // Which agent should execute
  priority    Int      @default(3) // 1-5, 1 is highest
  
  title       String
  description String?
  data        String?  // JSON task data
  
  // Scheduling
  scheduledFor DateTime
  deadline     DateTime?
  
  // Execution
  status       String   @default("scheduled") // scheduled, queued, running, completed, failed, cancelled
  startedAt    DateTime?
  completedAt  DateTime?
  
  // Results
  result       String?  // JSON result data
  errorMessage String?
  
  // Duration tracking
  estimatedMinutes Int?
  actualMinutes    Int?
  
  // Dependencies (JSON array of task IDs)
  dependencies String?
  
  // Recurring
  isRecurring  Boolean @default(false)
  cronSchedule String? // cron expression for recurring tasks
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([agentId])
  @@index([status])
  @@index([scheduledFor])
  @@index([priority])
}

// Agent decisions and learning
model AIDecision {
  id          String   @id @default(cuid())
  agentId     String   // master-agent typically
  
  type        String   // task-assignment, resource-allocation, escalation, optimization, recovery
  decision    String
  reasoning   String
  impact      String
  
  // Outcome tracking for learning
  reversible  Boolean  @default(true)
  status      String   @default("pending") // pending, executed, reverted, failed
  wasSuccessful Boolean?
  feedback    String?  // Human or automated feedback
  
  executedAt  DateTime?
  createdAt   DateTime @default(now())
  
  @@index([agentId])
  @@index([type])
  @@index([status])
}

// System alerts
model AIAlert {
  id          String   @id @default(cuid())
  
  level       String   // info, warning, error, critical
  source      String   // agent ID or system
  title       String
  message     String
  
  acknowledged Boolean  @default(false)
  acknowledgedBy String?
  acknowledgedAt DateTime?
  
  resolved    Boolean  @default(false)
  resolvedAt  DateTime?
  resolution  String?
  
  createdAt   DateTime @default(now())
  
  @@index([level])
  @@index([resolved])
  @@index([createdAt])
}

// Daily briefings generated by Master Agent
model AIDailyBriefing {
  id          String   @id @default(cuid())
  date        DateTime @unique // One per day
  
  // Summary
  healthScore Int
  healthStatus String // excellent, good, fair, poor, critical
  highlights   String // JSON array
  concerns     String // JSON array
  
  // Metrics snapshot
  metrics     String   // JSON metrics object
  
  // Tasks summary
  tasksCompleted Int
  tasksScheduled Int
  tasksOverdue   Int
  
  // Projects summary
  projectsActive Int
  projectsAtRisk Int
  
  // Marketing summary
  newLeads    Int
  activeCampaigns Int
  
  // Recommendations (JSON array)
  recommendations String
  
  // Action items (JSON array)
  actionItems String
  
  createdAt   DateTime @default(now())
  
  @@index([date])
}

// Agent performance history for optimization
model AIAgentMetrics {
  id          String   @id @default(cuid())
  agentId     String
  date        DateTime
  
  // Performance metrics
  tasksCompleted      Int      @default(0)
  avgResponseTimeMs   Int      @default(0)
  errorCount          Int      @default(0)
  successRate         Float    @default(100)
  
  // AI usage
  promptsGenerated    Int      @default(0)
  tokensUsed          Int      @default(0)
  aiCostCents         Int      @default(0)
  
  // Reports
  reportsGenerated    Int      @default(0)
  
  createdAt   DateTime @default(now())
  
  @@unique([agentId, date])
  @@index([agentId])
  @@index([date])
}

// ============================================
// AUTOMATION SERVICES
// ============================================

model AutomationSubscription {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Plan details
  planType        String   // starter, business, professional, enterprise
  planName        String
  monthlyPrice    Float
  billingPeriod   String   @default("monthly") // monthly, yearly
  
  // Limits
  maxWorkflows       Int
  maxExecutions      Int
  supportHoursIncl   Float  @default(0)
  supportHoursUsed   Float  @default(0)
  
  // Stripe
  stripeSubscriptionId String? @unique
  stripeCustomerId     String?
  
  // Status
  status          String   @default("active") // active, paused, cancelled, past_due
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  workflows       AutomationWorkflow[]
  executionLogs   AutomationExecutionLog[]
  supportRequests AutomationSupportRequest[]
  
  @@index([userId])
  @@index([status])
}

model AutomationWorkflow {
  id              String   @id @default(cuid())
  subscriptionId  String
  subscription    AutomationSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  // n8n reference
  n8nWorkflowId   String   @unique
  name            String
  description     String?
  
  // Status
  isActive        Boolean  @default(false)
  
  // Metadata
  category        String   // lead-capture, content, order, integration, custom
  complexity      String   // simple, medium, complex
  
  // Metrics (updated by monitoring)
  totalExecutions    Int      @default(0)
  successfulExecutions Int    @default(0)
  failedExecutions   Int      @default(0)
  lastExecutionAt    DateTime?
  lastErrorAt        DateTime?
  lastError          String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([subscriptionId])
  @@index([n8nWorkflowId])
}

model AutomationExecutionLog {
  id              String   @id @default(cuid())
  subscriptionId  String
  subscription    AutomationSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  workflowId      String?
  n8nExecutionId  String
  
  status          String   // success, error, running
  startedAt       DateTime
  finishedAt      DateTime?
  durationMs      Int?
  
  errorMessage    String?
  
  createdAt       DateTime @default(now())
  
  @@index([subscriptionId])
  @@index([workflowId])
  @@index([status])
}

model AutomationSupportRequest {
  id              String   @id @default(cuid())
  subscriptionId  String
  subscription    AutomationSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  type            String   // bug, change, new-feature, question
  priority        String   @default("normal") // low, normal, high, urgent
  
  subject         String
  description     String
  
  // Time tracking
  estimatedHours  Float?
  actualHours     Float?
  
  // Status
  status          String   @default("open") // open, in-progress, resolved, closed
  
  resolution      String?
  resolvedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([subscriptionId])
  @@index([status])
}

// Automation scan requests (from website form)
model AutomationScanRequest {
  id              String   @id @default(cuid())
  
  // Contact info
  naam            String
  email           String
  bedrijf         String
  
  // Details
  processen       String   // What they want to automate
  tijdPerWeek     String   // Time spent per week
  systemen        String   // JSON array of systems they use
  
  // Status
  status          String   @default("new") // new, contacted, qualified, converted, closed
  notes           String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([email])
  @@index([status])
}

// Automation intake questionnaire for new subscriptions
model AutomationIntake {
  id              String   @id @default(cuid())
  
  // Link to subscription (optional - filled after payment)
  subscriptionId  String?  @unique
  
  // Contact & Company info
  contactName     String
  email           String
  phone           String?
  companyName     String
  website         String?
  
  // Selected plan
  planType        String   // starter, business, professional, enterprise
  billingPeriod   String   // monthly, yearly
  
  // Workflow preferences (JSON arrays)
  workflowTypes   String   // JSON: ["lead-capture", "content", "e-commerce", etc.]
  priorityWorkflow String? // Most important workflow to start with
  
  // Systems & Integrations
  currentSystems  String   // JSON: List of systems they use
  systemCredentials String? // JSON: Encrypted/reference to credentials
  
  // Business context
  teamSize        String?  // 1, 2-5, 6-10, 11-25, 25+
  monthlyVolume   String?  // Estimated monthly transactions/tasks
  
  // Specific workflow requirements (JSON object per workflow type)
  leadCaptureDetails    String?  // JSON: CRM, lead sources, notification prefs
  contentDetails        String?  // JSON: Platforms, posting schedule, content types
  ecommerceDetails      String?  // JSON: Platform, payment provider, shipping
  invoicingDetails      String?  // JSON: Accounting software, invoice templates
  customerServiceDetails String? // JSON: Channels, escalation rules
  customRequirements    String?  // Free text for anything else
  
  // Scheduling preferences
  preferredContactTime  String?  // Morning, Afternoon, Evening
  timezone              String   @default("Europe/Amsterdam")
  kickoffDate           DateTime? // Preferred start date
  
  // Agreements
  termsAccepted         Boolean  @default(false)
  dataProcessingAccepted Boolean @default(false)
  
  // Status
  status          String   @default("draft") // draft, submitted, reviewed, approved, active
  reviewNotes     String?
  reviewedAt      DateTime?
  reviewedBy      String?
  
  // Payment
  stripeSessionId String?  @unique
  paymentStatus   String   @default("pending") // pending, paid, failed
  paidAt          DateTime?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([email])
  @@index([status])
  @@index([planType])
}
