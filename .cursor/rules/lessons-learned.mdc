---
name: lessons-learned
description: Geleerde lessen en veelvoorkomende problemen uit eerdere sessies
globs:
  - "**/*"
---

# üìö LESSONS LEARNED - Historische Kennis

Dit bestand bevat geleerde lessen uit eerdere development sessies. Update dit bij nieuwe inzichten.

---

## üö® KRITIEKE PRE-DEPLOY CHECKS

### Voordat je pusht naar GitHub/Vercel:

```bash
# ALTIJD lokaal testen - Vercel gebruikt Turbopack die strenger is
npm run build

# Als build faalt, fix ALLE errors voordat je pushed
# TypeScript errors die lokaal "werken" kunnen op Vercel falen
```

### Veelvoorkomende Vercel Build Failures:

| Symptoom | Oorzaak | Fix |
|----------|---------|-----|
| `Module not found: Can't resolve '@/...'` | Import path bestaat niet | Check tsconfig.json paths, verifieer bestand bestaat |
| `Export X doesn't exist in target module` | Verkeerde import syntax voor library versie | Check library docs voor juiste syntax |
| `Property X does not exist on type Y` | Type definitions mismatch | Gebruik type assertions of update types |
| `Type error: Class incorrectly extends base class` | Visibility conflicts (private vs protected) | Rename conflicting properties |

---

## üì¶ LIBRARY VERSIE SPECIFIEKE ISSUES

### NextAuth v5 (beta) - NIET v4 syntax gebruiken!

```typescript
// ‚ùå FOUT (v4 syntax - werkt NIET in dit project)
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";
const session = await getServerSession(authOptions);

// ‚úÖ CORRECT (v5 syntax)
import { auth } from "@/lib/auth";
const session = await auth();
```

### Zod - Nieuwere versies

```typescript
// ‚ùå FOUT - .errors bestaat niet meer
if (error instanceof z.ZodError) {
  return error.errors[0]?.message;
}

// ‚úÖ CORRECT - gebruik .issues
if (error instanceof z.ZodError) {
  return error.issues[0]?.message;
}
```

### Stripe API - Type Changes

Stripe API types veranderen regelmatig. Gebruik type assertions voor backward compatibility:

```typescript
// ‚ùå FOUT - Property bestaat mogelijk niet in nieuwere versie
const periodStart = subscription.current_period_start;

// ‚úÖ CORRECT - Safe type assertion
const periodStart = (subscription as unknown as { current_period_start?: number }).current_period_start;
const startDate = periodStart ? new Date(periodStart * 1000) : new Date();
```

---

## üîß TSCONFIG.JSON MANAGEMENT

### Exclude Incomplete Folders

Als een folder TypeScript errors heeft maar nog niet klaar is voor productie:

```json
{
  "exclude": [
    "node_modules",
    "mobile-app",
    "tools",
    "ai-agents"  // <-- Voeg toe als folder niet klaar is
  ]
}
```

### Path Aliases

Alle `@/` imports moeten verwijzen naar bestaande bestanden:

```json
{
  "paths": {
    "@/*": ["./src/*"]
  }
}
```

**Check:** `@/lib/prisma` ‚Üí `src/lib/prisma.ts` moet bestaan

---

## ü™ü WINDOWS-SPECIFIEKE ISSUES

### Git Lock Files

```powershell
# Bij "Unable to create index.lock" errors:
Remove-Item -Force ".git/index.lock" -ErrorAction SilentlyContinue
git add -A
```

### PowerShell Syntax

```powershell
# ‚ùå FOUT - Bash syntax werkt niet in PowerShell
git add -A && git commit -m "message"

# ‚úÖ CORRECT - Aparte commands of puntkomma
git add -A; git commit -m "message"
# Of gebruik enkele commands
```

### HEREDOC voor commit messages werkt niet in PowerShell

```powershell
# ‚ùå FOUT - HEREDOC syntax
git commit -m "$(cat <<'EOF'
Multi-line message
EOF
)"

# ‚úÖ CORRECT - Eenvoudige message
git commit -m "feat: beschrijving in √©√©n regel"
```

---

## üîç AUDIT CHECKLIST

Bij build failures, doorloop deze checklist:

1. **Import Errors**
   ```bash
   # Zoek naar niet-bestaande imports
   rg "@/ai-agents" src/
   rg "from ['\"]@/" src/ | grep -v "from '@/lib\|from '@/components\|from '@/data\|from '@/app"
   ```

2. **Type Errors**
   - Check of library versies zijn veranderd (package.json vs docs)
   - Controleer breaking changes in changelogs

3. **NextAuth Issues**
   - Altijd `auth()` gebruiken, nooit `getServerSession(authOptions)`

4. **Zod Issues**
   - Altijd `.issues` gebruiken, nooit `.errors`

5. **Prisma Schema Sync**
   ```bash
   npm run db:push  # Sync schema met database
   ```

---

## üéØ BEST PRACTICES VOOR TOEKOMST

### Pre-Commit Workflow

```bash
# 1. Lint check
npm run lint

# 2. Build test (CRUCIAAL!)
npm run build

# 3. Dan pas committen
git add -A
git commit -m "description"
git push
```

### Bij Nieuwe Dependencies

1. Check of het compatible is met Next.js 16+
2. Check TypeScript support
3. Lees de breaking changes als je upgradet
4. Test lokaal met `npm run build`

### Bij Refactoring

1. Zoek ALLE imports van gewijzigde exports
2. Update alle referenties VOOR de push
3. Test met `npm run build`

---

## üìù SESSIE LOG FORMAT

Bij belangrijke fixes, log ze hier voor toekomstige referentie:

### 2026-01-27: Vercel Build Fixes
- **Issue:** Meerdere TypeScript errors bij Vercel build
- **Root cause:** Verouderde imports, library versie mismatches
- **Fixes:**
  - NextAuth v4 ‚Üí v5 syntax
  - Zod .errors ‚Üí .issues
  - Stripe type assertions
  - tsconfig.json ai-agents exclude
- **Preventie:** Altijd `npm run build` lokaal testen

### 2026-01-27: Vercel Bouwt Oude Commit
- **Issue:** Vercel bleef oude commit (a1711b8) bouwen ipv nieuwe (a101ca6)
- **Root cause:** Push succesvol maar Vercel webhook of cache issue
- **Diagnose:**
  ```bash
  # Check lokale vs remote
  git log --oneline -1          # Lokale HEAD
  git fetch origin
  git log origin/main --oneline -1  # Remote HEAD
  # Als deze verschillen: push niet doorgekomen
  # Als gelijk: Vercel webhook/cache issue
  ```
- **Fixes:**
  1. `git push --force-with-lease` (als push niet doorkwam)
  2. Vercel Dashboard ‚Üí Deployments ‚Üí Redeploy (zonder cache)
  3. Controleer dat juiste commit hash wordt getoond
- **Preventie:**
  - Altijd verifieer dat remote is bijgewerkt na push
  - Na push check: Vercel moet nieuwe build starten binnen 1-2 min
  - Als geen build: handmatig triggeren

### Vercel Environment Variables Checklist
Bij "Configuration" errors op login/auth pages:
```
VERPLICHT IN VERCEL:
‚îú‚îÄ‚îÄ DATABASE_URL          ‚Üí postgresql://...
‚îú‚îÄ‚îÄ NEXTAUTH_SECRET       ‚Üí Random 32+ char string
‚îú‚îÄ‚îÄ NEXTAUTH_URL          ‚Üí https://ro-techdevelopment.dev
‚îú‚îÄ‚îÄ ADMIN_SETUP_KEY       ‚Üí Voor admin setup API
‚îî‚îÄ‚îÄ [API KEYS]            ‚Üí Stripe, Resend, etc.

NA TOEVOEGEN ‚Üí REDEPLOY VEREIST!
```

---

*Update dit bestand bij elk nieuw geleerd patroon of veelvoorkomend probleem.*
